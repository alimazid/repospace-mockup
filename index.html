<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>RepoSpace</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #09090b;
    --surface: #18181b;
    --surface-2: #27272a;
    --border: rgba(255,255,255,0.08);
    --border-hover: rgba(255,255,255,0.15);
    --text: #fafafa;
    --text-2: #a1a1aa;
    --text-3: #71717a;
    --accent: #3b82f6;
    --accent-soft: rgba(59,130,246,0.12);
    --green: #22c55e;
    --green-soft: rgba(34,197,94,0.12);
    --orange: #f59e0b;
    --orange-soft: rgba(245,158,11,0.12);
    --radius: 10px;
    --radius-sm: 6px;
    --font: 'Inter', -apple-system, system-ui, sans-serif;
    --transition: 150ms cubic-bezier(0.4, 0, 0.2, 1);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  html, body { overflow-x: hidden; max-width: 100vw; }

  body {
    font-family: var(--font);
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    font-size: 14px;
  }

  ::selection { background: var(--accent-soft); color: var(--accent); }

  /* ── Sidebar + Layout ── */
  .layout {
    display: flex;
    min-height: 100vh;
  }

  .sidebar {
    width: 240px;
    border-right: 1px solid var(--border);
    padding: 16px 0;
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    background: var(--bg);
    z-index: 50;
    transition: transform var(--transition);
  }

  .sidebar-header {
    padding: 0 16px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .logo {
    font-size: 15px;
    font-weight: 600;
    letter-spacing: -0.3px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .logo-icon {
    width: 22px;
    height: 22px;
    border-radius: 6px;
    background: var(--accent);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    color: #fff;
  }

  .sidebar-section {
    padding: 8px 8px;
  }

  .sidebar-label {
    font-size: 11px;
    font-weight: 500;
    color: var(--text-3);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 0 8px 6px;
  }

  .sidebar-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 7px 10px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    color: var(--text-2);
    transition: all var(--transition);
    font-size: 13px;
  }

  .sidebar-item:hover { background: var(--surface); color: var(--text); }
  .sidebar-item.active { background: var(--surface); color: var(--text); }

  .sidebar-item .icon {
    width: 16px;
    text-align: center;
    font-size: 14px;
    opacity: 0.7;
  }

  .sidebar-item .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .sidebar-spacer { flex: 1; }

  .sidebar-footer {
    padding: 12px 16px;
    border-top: 1px solid var(--border);
  }

  .user-pill {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 8px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: background var(--transition);
  }

  .user-pill:hover { background: var(--surface); }

  .user-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), #8b5cf6);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
  }

  .user-name { font-size: 13px; color: var(--text-2); }

  .user-menu {
    display: none;
    margin-top: 6px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    overflow: hidden;
  }

  .user-menu.open { display: block; }

  .user-menu-item {
    padding: 8px 12px;
    font-size: 13px;
    color: var(--text-2);
    cursor: pointer;
    transition: all var(--transition);
  }

  .user-menu-item:hover { background: var(--surface-2); color: var(--text); }

  /* ── Main Content ── */
  .main {
    flex: 1;
    margin-left: 240px;
    min-height: 100vh;
  }

  .page-header {
    padding: 32px 40px 24px;
    border-bottom: 1px solid var(--border);
  }

  .page-header h1 {
    font-size: 20px;
    font-weight: 600;
    letter-spacing: -0.3px;
    margin-bottom: 4px;
  }

  .page-header p {
    color: var(--text-3);
    font-size: 13px;
  }

  .content {
    padding: 0 40px;
  }

  /* ── Repo Cards ── */
  .repo-grid {
    padding: 24px 0;
    display: grid;
    gap: 1px;
    background: var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    border: 1px solid var(--border);
  }

  .repo-row {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 14px 20px;
    background: var(--bg);
    cursor: pointer;
    transition: background var(--transition);
  }

  .repo-row:hover { background: var(--surface); }

  .repo-row .repo-icon {
    width: 34px;
    height: 34px;
    border-radius: 8px;
    background: var(--surface);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    flex-shrink: 0;
    border: 1px solid var(--border);
  }

  .repo-row .info { flex: 1; min-width: 0; }

  .repo-row .name {
    font-size: 14px;
    font-weight: 500;
    color: var(--text);
  }

  .repo-row .desc {
    font-size: 12px;
    color: var(--text-3);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .repo-row .meta {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-shrink: 0;
  }

  .repo-row .lang {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 12px;
    color: var(--text-3);
  }

  .repo-row .lang .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .repo-row .updated {
    font-size: 12px;
    color: var(--text-3);
    white-space: nowrap;
  }

  .badge {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 20px;
    font-weight: 500;
    white-space: nowrap;
  }

  .badge-blue { background: var(--accent-soft); color: var(--accent); }
  .badge-green { background: var(--green-soft); color: var(--green); }
  .badge-orange { background: var(--orange-soft); color: var(--orange); }

  /* ── Branch Switcher ── */
  .branch-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 40px 0;
  }

  .branch-select {
    position: relative;
  }

  .branch-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-size: 13px;
    font-family: var(--font);
    cursor: pointer;
    transition: all var(--transition);
  }

  .branch-btn:hover { border-color: var(--border-hover); }

  .branch-btn .branch-icon {
    font-size: 14px;
    opacity: 0.6;
  }

  .branch-btn .arrow {
    font-size: 10px;
    color: var(--text-3);
    margin-left: 4px;
  }

  .branch-dropdown {
    display: none;
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    min-width: 240px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: 0 8px 30px rgba(0,0,0,0.4);
    z-index: 80;
    overflow: hidden;
  }

  .branch-dropdown.open { display: block; }

  .branch-dropdown-header {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
    font-weight: 500;
    color: var(--text-3);
  }

  .branch-search {
    width: 100%;
    padding: 8px 12px;
    background: var(--bg);
    border: none;
    border-bottom: 1px solid var(--border);
    color: var(--text);
    font-size: 13px;
    font-family: var(--font);
    outline: none;
  }

  .branch-option {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    cursor: pointer;
    font-size: 13px;
    color: var(--text-2);
    transition: background var(--transition);
  }

  .branch-option:hover { background: var(--surface-2); color: var(--text); }
  .branch-option.active { color: var(--text); }

  .branch-option .check-mark {
    color: var(--accent);
    font-size: 14px;
  }

  .branch-option .branch-meta {
    font-size: 11px;
    color: var(--text-3);
  }

  /* ── Tabs (Files / Commits) ── */
  .view-tabs {
    display: flex;
    gap: 0;
    padding: 12px 40px 0;
  }

  .view-tab {
    padding: 8px 16px;
    font-size: 13px;
    color: var(--text-3);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all var(--transition);
    font-family: var(--font);
    background: none;
    border-top: none;
    border-left: none;
    border-right: none;
  }

  .view-tab:hover { color: var(--text-2); }
  .view-tab.active { color: var(--text); border-bottom-color: var(--accent); }

  .tab-divider {
    border-bottom: 1px solid var(--border);
    margin-top: -1px;
  }

  /* ── Commit History ── */
  .commit-list {
    padding: 0;
  }

  .commit-group-label {
    padding: 16px 40px 8px;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-3);
  }

  .commit-row {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px 40px;
    border-bottom: 1px solid var(--border);
    transition: background var(--transition);
    cursor: pointer;
  }

  .commit-row:hover { background: var(--surface); }

  .commit-row .commit-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--surface-2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    flex-shrink: 0;
    color: var(--text-2);
    margin-top: 1px;
  }

  .commit-row .commit-avatar.bot {
    background: var(--accent-soft);
    color: var(--accent);
  }

  .commit-info { flex: 1; min-width: 0; }

  .commit-msg {
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
    margin-bottom: 2px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .commit-detail {
    font-size: 12px;
    color: var(--text-3);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .commit-detail .author { color: var(--text-2); }

  .commit-sha {
    font-family: 'SF Mono', 'Fira Code', monospace;
    font-size: 12px;
    color: var(--accent);
    background: var(--accent-soft);
    padding: 2px 8px;
    border-radius: 4px;
    flex-shrink: 0;
    cursor: pointer;
    transition: opacity var(--transition);
  }

  .commit-sha:hover { opacity: 0.8; }

  .commit-stats {
    display: flex;
    gap: 8px;
    flex-shrink: 0;
    font-size: 12px;
    font-family: 'SF Mono', monospace;
  }

  .commit-stats .additions { color: var(--green); }
  .commit-stats .deletions { color: #ef4444; }

  @media (max-width: 768px) {
    .branch-bar { padding: 12px 16px 0; }
    .view-tabs { padding: 8px 16px 0; }
    .commit-group-label { padding: 12px 16px 6px; }
    .commit-row { padding: 10px 16px; }
    .commit-stats { display: none; }
  }

  /* ── File Browser ── */
  .file-header {
    padding: 20px 40px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
  }

  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 13px;
  }

  .breadcrumb a {
    color: var(--text-3);
    text-decoration: none;
    cursor: pointer;
    transition: color var(--transition);
  }

  .breadcrumb a:hover { color: var(--text); }
  .breadcrumb .sep { color: var(--text-3); opacity: 0.4; }
  .breadcrumb .current { color: var(--text); font-weight: 500; }

  .file-count { font-size: 12px; color: var(--text-3); }

  .file-table {
    margin: 0;
  }

  .file-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 40px;
    cursor: pointer;
    transition: background var(--transition);
    border-bottom: 1px solid var(--border);
  }

  .file-row:last-child { border-bottom: none; }
  .file-row:hover { background: var(--surface); }

  .file-row .f-icon {
    width: 20px;
    text-align: center;
    font-size: 14px;
    flex-shrink: 0;
    opacity: 0.6;
  }

  .file-row .f-name {
    flex: 1;
    font-size: 13px;
    font-weight: 400;
    color: var(--text);
  }

  .file-row .f-name.folder { color: var(--text-2); }

  .file-row .f-badge {
    font-size: 11px;
    color: var(--green);
    background: var(--green-soft);
    padding: 1px 7px;
    border-radius: 20px;
  }

  .file-row .f-meta {
    font-size: 12px;
    color: var(--text-3);
    width: 80px;
    text-align: right;
    flex-shrink: 0;
  }

  .file-row .f-time {
    font-size: 12px;
    color: var(--text-3);
    width: 70px;
    text-align: right;
    flex-shrink: 0;
  }

  /* ── Document View ── */
  .doc-toolbar {
    padding: 12px 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: var(--bg);
    z-index: 10;
  }

  .doc-toolbar-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .doc-toolbar .back {
    color: var(--text-3);
    text-decoration: none;
    cursor: pointer;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 4px;
    transition: color var(--transition);
  }

  .doc-toolbar .back:hover { color: var(--text); }

  .doc-toolbar .doc-name {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-2);
  }

  .doc-toolbar-right {
    display: flex;
    gap: 6px;
  }

  .btn {
    padding: 5px 12px;
    border-radius: var(--radius-sm);
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-2);
    transition: all var(--transition);
    font-family: var(--font);
  }

  .btn:hover { background: var(--surface); color: var(--text); border-color: var(--border-hover); }

  .btn-primary {
    background: var(--text);
    color: var(--bg);
    border-color: var(--text);
  }

  .btn-primary:hover { opacity: 0.9; background: var(--text); color: var(--bg); }

  /* Document content */
  .doc-content {
    max-width: 720px;
    margin: 0 auto;
    padding: 40px 40px 80px;
  }

  .doc-meta {
    font-size: 12px;
    color: var(--text-3);
    margin-bottom: 32px;
    display: flex;
    gap: 16px;
  }

  .doc-content h1 {
    font-size: 32px;
    font-weight: 600;
    letter-spacing: -0.5px;
    line-height: 1.2;
    margin-bottom: 8px;
  }

  .doc-content h2 {
    font-size: 18px;
    font-weight: 600;
    letter-spacing: -0.2px;
    margin: 36px 0 12px;
    color: var(--text);
  }

  .doc-content h3 {
    font-size: 15px;
    font-weight: 600;
    margin: 24px 0 8px;
    color: var(--text);
  }

  .doc-content p {
    margin-bottom: 16px;
    color: var(--text-2);
    font-size: 14px;
    line-height: 1.7;
  }

  .doc-content ul, .doc-content ol {
    margin-bottom: 16px;
    padding-left: 20px;
  }

  .doc-content li {
    margin-bottom: 6px;
    font-size: 14px;
    line-height: 1.6;
    color: var(--text-2);
  }

  .doc-content code {
    background: var(--surface);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
    font-family: 'SF Mono', 'Fira Code', monospace;
    color: var(--text);
  }

  .doc-content pre {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 16px;
    overflow-x: auto;
  }

  .doc-content pre code {
    background: none;
    padding: 0;
    font-size: 13px;
    line-height: 1.6;
  }

  .doc-content blockquote {
    border-left: 2px solid var(--surface-2);
    padding-left: 16px;
    margin: 0 0 16px;
    color: var(--text-3);
  }

  .doc-content strong { color: var(--text); font-weight: 600; }

  .doc-content .checklist {
    list-style: none;
    padding-left: 0;
  }

  .doc-content .checklist li {
    display: flex;
    align-items: flex-start;
    gap: 8px;
  }

  .doc-content .check { opacity: 0.5; }
  .doc-content .check.done { opacity: 1; }

  /* Editor */
  .editor-wrap {
    display: none;
    max-width: 720px;
    margin: 0 auto;
    padding: 20px 40px 80px;
  }

  .editor-wrap.active { display: block; }

  .editor-bar {
    display: flex;
    gap: 2px;
    padding: 8px 0 12px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 16px;
  }

  .editor-bar button {
    background: none;
    border: none;
    color: var(--text-3);
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 13px;
    font-family: var(--font);
    transition: all var(--transition);
  }

  .editor-bar button:hover { background: var(--surface); color: var(--text); }

  .editor-ta {
    width: 100%;
    min-height: 500px;
    background: transparent;
    border: none;
    color: var(--text-2);
    font-family: 'SF Mono', 'Fira Code', Consolas, monospace;
    font-size: 13px;
    line-height: 1.7;
    resize: vertical;
    outline: none;
    tab-size: 2;
  }

  /* Save bar */
  .save-bar {
    display: none;
    position: fixed;
    bottom: 0;
    left: 240px;
    right: 0;
    background: var(--surface);
    border-top: 1px solid var(--border);
    padding: 10px 40px;
    align-items: center;
    gap: 10px;
    z-index: 100;
  }

  .save-bar.active { display: flex; }

  .save-bar input {
    flex: 1;
    padding: 7px 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-size: 13px;
    font-family: var(--font);
    outline: none;
    transition: border-color var(--transition);
  }

  .save-bar input:focus { border-color: var(--accent); }

  /* Toast */
  .toast {
    display: none;
    position: fixed;
    bottom: 70px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--text);
    color: var(--bg);
    padding: 8px 20px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
    z-index: 200;
    animation: fadeUp 0.25s ease;
  }

  .toast.show { display: block; }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateX(-50%) translateY(8px); }
    to { opacity: 1; transform: translateX(-50%) translateY(0); }
  }

  /* ── Auth Screens ── */
  .auth-screen {
    display: none;
    min-height: 100vh;
    align-items: center;
    justify-content: center;
    background: var(--bg);
    position: fixed;
    inset: 0;
    z-index: 500;
    flex-direction: column;
  }

  .auth-screen.active { display: flex; }

  .auth-card {
    width: 100%;
    max-width: 400px;
    padding: 40px 32px;
    text-align: center;
  }

  .auth-logo {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-bottom: 32px;
    font-size: 22px;
    font-weight: 600;
    letter-spacing: -0.5px;
  }

  .auth-logo .logo-icon {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    background: var(--accent);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: 700;
    color: #fff;
  }

  .auth-title {
    font-size: 24px;
    font-weight: 600;
    letter-spacing: -0.3px;
    margin-bottom: 8px;
  }

  .auth-subtitle {
    font-size: 14px;
    color: var(--text-3);
    margin-bottom: 32px;
    line-height: 1.5;
  }

  .auth-btn-github {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    width: 100%;
    padding: 12px 20px;
    background: #f0f0f0;
    color: #000;
    border: none;
    border-radius: var(--radius);
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    font-family: var(--font);
    transition: all var(--transition);
  }

  .auth-btn-github:hover { background: #fff; }

  .auth-btn-github svg {
    width: 20px;
    height: 20px;
  }

  .auth-features {
    margin-top: 40px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    text-align: left;
  }

  .auth-feature {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    font-size: 13px;
    color: var(--text-2);
  }

  .auth-feature .af-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: var(--surface);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    flex-shrink: 0;
  }

  .auth-feature .af-text strong {
    display: block;
    color: var(--text);
    font-size: 13px;
    margin-bottom: 2px;
  }

  .auth-divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 24px 0;
    font-size: 12px;
    color: var(--text-3);
  }

  .auth-divider::before, .auth-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .auth-footer {
    margin-top: 24px;
    font-size: 12px;
    color: var(--text-3);
  }

  .auth-footer a {
    color: var(--accent);
    text-decoration: none;
  }

  /* GitHub Permission Screen */
  .gh-auth-screen {
    display: none;
    min-height: 100vh;
    align-items: center;
    justify-content: center;
    background: #0d1117;
    position: fixed;
    inset: 0;
    z-index: 600;
    flex-direction: column;
  }

  .gh-auth-screen.active { display: flex; }

  .gh-auth-card {
    width: 100%;
    max-width: 440px;
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 12px;
    overflow: hidden;
    margin: 16px;
  }

  .gh-auth-header {
    padding: 24px 24px 16px;
    text-align: center;
    border-bottom: 1px solid #30363d;
  }

  .gh-auth-header svg { margin-bottom: 12px; }

  .gh-auth-header h2 {
    font-size: 18px;
    font-weight: 600;
    color: #e6edf3;
    margin-bottom: 4px;
  }

  .gh-auth-header p {
    font-size: 13px;
    color: #7d8590;
  }

  .gh-perms {
    padding: 16px 24px;
  }

  .gh-perm-section {
    margin-bottom: 12px;
  }

  .gh-perm-label {
    font-size: 12px;
    font-weight: 500;
    color: #7d8590;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    margin-bottom: 8px;
  }

  .gh-perm-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    font-size: 13px;
    color: #e6edf3;
  }

  .gh-perm-item .gh-check {
    color: #3fb950;
    font-size: 16px;
  }

  .gh-perm-item .gh-desc {
    color: #7d8590;
    font-size: 12px;
  }

  .gh-auth-actions {
    padding: 16px 24px 24px;
    display: flex;
    gap: 10px;
  }

  .gh-btn {
    flex: 1;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    font-family: var(--font);
    border: 1px solid #30363d;
    transition: all var(--transition);
  }

  .gh-btn-cancel {
    background: transparent;
    color: #e6edf3;
  }

  .gh-btn-cancel:hover { background: #21262d; }

  .gh-btn-authorize {
    background: #238636;
    color: #fff;
    border-color: #238636;
  }

  .gh-btn-authorize:hover { background: #2ea043; }

  /* Loading Screen */
  .loading-screen {
    display: none;
    min-height: 100vh;
    align-items: center;
    justify-content: center;
    background: var(--bg);
    position: fixed;
    inset: 0;
    z-index: 550;
    flex-direction: column;
    gap: 16px;
  }

  .loading-screen.active { display: flex; }

  .loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--surface-2);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text {
    font-size: 14px;
    color: var(--text-3);
  }

  .loading-steps {
    margin-top: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .loading-step {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: var(--text-3);
    transition: color 0.3s;
  }

  .loading-step.done { color: var(--green); }
  .loading-step.active { color: var(--text); }

  .loading-step .ls-icon {
    width: 18px;
    text-align: center;
    font-size: 14px;
  }

  /* Screens */
  .screen { display: none; }
  .screen.active { display: block; }

  /* ── Mobile ── */
  .mobile-header {
    display: none;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    background: var(--bg);
    z-index: 60;
  }

  .hamburger {
    background: none;
    border: none;
    color: var(--text);
    font-size: 20px;
    cursor: pointer;
    padding: 4px;
  }

  .overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 40;
  }

  /* ── Drag & Drop ── */
  .file-row.dragging {
    opacity: 0.4;
    background: var(--surface);
  }

  .file-row.drag-over {
    background: var(--accent-soft);
    border-top: 2px solid var(--accent);
    margin-top: -2px;
  }

  .file-row.drag-over-folder {
    background: var(--accent-soft);
    outline: 2px solid var(--accent);
    outline-offset: -2px;
    border-radius: var(--radius-sm);
  }

  .drag-ghost {
    position: fixed;
    pointer-events: none;
    z-index: 999;
    background: var(--surface);
    border: 1px solid var(--accent);
    border-radius: var(--radius-sm);
    padding: 6px 12px;
    font-size: 13px;
    color: var(--text);
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    display: none;
  }

  /* ── Changeset Panel ── */
  .changeset-bar {
    display: none;
    position: fixed;
    bottom: 0;
    left: 240px;
    right: 0;
    background: var(--surface);
    border-top: 1px solid var(--border);
    z-index: 100;
    flex-direction: column;
    max-height: 50vh;
  }

  .changeset-bar.active { display: flex; }

  .changeset-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
  }

  .changeset-header:hover { background: var(--surface-2); }

  .changeset-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    font-weight: 500;
  }

  .changeset-count {
    background: var(--accent);
    color: #fff;
    font-size: 11px;
    padding: 1px 7px;
    border-radius: 10px;
    font-weight: 600;
  }

  .changeset-actions {
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .changeset-items {
    overflow-y: auto;
    max-height: 200px;
    padding: 0;
  }

  .changeset-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 16px;
    font-size: 13px;
    border-bottom: 1px solid var(--border);
  }

  .changeset-item:last-child { border-bottom: none; }

  .changeset-item .cs-icon {
    font-size: 14px;
    opacity: 0.6;
  }

  .changeset-item .cs-action {
    font-size: 11px;
    font-weight: 500;
    padding: 1px 6px;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .changeset-item .cs-action.move {
    background: var(--accent-soft);
    color: var(--accent);
  }

  .changeset-item .cs-paths {
    flex: 1;
    min-width: 0;
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: 'SF Mono', 'Fira Code', monospace;
    font-size: 12px;
    color: var(--text-2);
  }

  .changeset-item .cs-from {
    color: var(--text-3);
    text-decoration: line-through;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .changeset-item .cs-arrow { color: var(--text-3); flex-shrink: 0; }

  .changeset-item .cs-to {
    color: var(--green);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .changeset-item .cs-undo {
    background: none;
    border: none;
    color: var(--text-3);
    cursor: pointer;
    font-size: 14px;
    padding: 2px 6px;
    border-radius: 4px;
    transition: all var(--transition);
    flex-shrink: 0;
  }

  .changeset-item .cs-undo:hover { background: var(--surface-2); color: #ef4444; }

  .changeset-commit {
    display: flex;
    gap: 8px;
    padding: 10px 16px;
    border-top: 1px solid var(--border);
    align-items: center;
  }

  .changeset-commit input {
    flex: 1;
    padding: 7px 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-size: 13px;
    font-family: var(--font);
    outline: none;
  }

  .changeset-commit input:focus { border-color: var(--accent); }

  /* Breadcrumb drop target */
  .breadcrumb a.drag-over-bc {
    background: var(--accent-soft);
    border-radius: 4px;
    padding: 2px 4px;
    color: var(--accent) !important;
  }

  @media (max-width: 768px) {
    .sidebar {
      transform: translateX(-100%);
      width: 280px;
    }
    .sidebar.open { transform: translateX(0); }
    .overlay.open { display: block; }
    .main { margin-left: 0; }
    .mobile-header { display: flex; }
    .page-header { padding: 20px 16px 16px; }
    .content { padding: 0 16px; }
    .file-header { padding: 16px 16px 12px; }
    .file-row { padding: 10px 16px; }
    .file-row .f-meta { display: none; }
    .doc-toolbar { padding: 10px 16px; }
    .doc-content { padding: 24px 16px 80px; }
    .doc-content h1 { font-size: 24px; }
    .editor-wrap { padding: 16px 16px 80px; }
    .save-bar { left: 0; padding: 10px 16px; }
    .changeset-bar { left: 0; }
    .repo-row .meta { display: none; }
    .repo-row { padding: 12px 16px; }
    .repo-row .info { overflow: hidden; min-width: 0; }
    .repo-row .desc { white-space: normal; }
    .repo-grid { border: none; border-radius: 0; margin: 0 -16px; width: calc(100% + 32px); }
    .layout { overflow-x: hidden; }
    .mobile-header { padding: 12px 16px; overflow: hidden; }
  }
</style>
</head>
<body>

<!-- Auth: Login Screen -->
<div class="auth-screen active" id="auth-login">
  <div class="auth-card">
    <div class="auth-logo" onclick="skipAuth()" style="cursor:default">
      <div class="logo-icon">R</div>
      RepoSpace
    </div>
    <h1 class="auth-title">Your repos, reimagined</h1>
    <p class="auth-subtitle">Browse, edit, and manage your GitHub repositories with a modern interface designed for humans and AI agents.</p>
    <button class="auth-btn-github" onclick="showGitHubAuth()">
      <svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
      Sign in with GitHub
    </button>
    <div class="auth-features">
      <div class="auth-feature">
        <div class="af-icon">&#128194;</div>
        <div class="af-text">
          <strong>File browser</strong>
          Navigate repos like a filesystem
        </div>
      </div>
      <div class="auth-feature">
        <div class="af-icon">&#9998;</div>
        <div class="af-text">
          <strong>Quick edit</strong>
          Edit and commit from any device
        </div>
      </div>
      <div class="auth-feature">
        <div class="af-icon">&#128340;</div>
        <div class="af-text">
          <strong>Activity feed</strong>
          See what your agents changed
        </div>
      </div>
    </div>
    <p class="auth-footer">By signing in, you agree to our <a href="#">Terms</a> and <a href="#">Privacy Policy</a></p>
  </div>
</div>

<!-- Auth: GitHub Permission Screen -->
<div class="gh-auth-screen" id="auth-github">
  <div class="gh-auth-card">
    <div class="gh-auth-header">
      <svg width="32" height="32" viewBox="0 0 16 16" fill="#e6edf3"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
      <h2>Authorize RepoSpace</h2>
      <p>RepoSpace by repospace.dev wants to access your account</p>
    </div>
    <div class="gh-perms">
      <div class="gh-perm-section">
        <div class="gh-perm-label">Permissions requested</div>
        <div class="gh-perm-item">
          <span class="gh-check">&#10003;</span>
          <div>
            <div>Read access to your repositories</div>
            <div class="gh-desc">View repo contents, branches, and commits</div>
          </div>
        </div>
        <div class="gh-perm-item">
          <span class="gh-check">&#10003;</span>
          <div>
            <div>Write access to repository contents</div>
            <div class="gh-desc">Create commits, edit files, move files</div>
          </div>
        </div>
        <div class="gh-perm-item">
          <span class="gh-check">&#10003;</span>
          <div>
            <div>Read your profile information</div>
            <div class="gh-desc">Username, avatar, and email</div>
          </div>
        </div>
      </div>
    </div>
    <div class="gh-auth-actions">
      <button class="gh-btn gh-btn-cancel" onclick="cancelGitHubAuth()">Cancel</button>
      <button class="gh-btn gh-btn-authorize" onclick="authorizeGitHub()">Authorize RepoSpace</button>
    </div>
  </div>
</div>

<!-- Auth: Loading Screen -->
<div class="loading-screen" id="auth-loading">
  <div class="loading-spinner"></div>
  <div class="loading-text">Connecting to GitHub...</div>
  <div class="loading-steps">
    <div class="loading-step" id="ls-auth"><span class="ls-icon">&#9711;</span> Authenticating</div>
    <div class="loading-step" id="ls-repos"><span class="ls-icon">&#9711;</span> Loading repositories</div>
    <div class="loading-step" id="ls-ready"><span class="ls-icon">&#9711;</span> Preparing workspace</div>
  </div>
</div>

<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

<div class="layout" id="main-layout" style="display:none">
  <!-- ── Sidebar ── -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo" onclick="goHome()">
        <div class="logo-icon">R</div>
        RepoSpace
      </div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-label">Repositories</div>
      <div id="sidebar-repos"></div>
    </div>

    <div class="sidebar-spacer"></div>

    <div class="sidebar-footer">
      <div class="user-pill" onclick="toggleUserMenu(event)">
        <div class="user-avatar">A</div>
        <span class="user-name">alimazid</span>
        <span style="margin-left:auto;font-size:10px;color:var(--text-3)">&#9662;</span>
      </div>
      <div class="user-menu" id="user-menu">
        <div class="user-menu-item" onclick="toast('Settings coming soon')">&#9881; Settings</div>
        <div class="user-menu-item" onclick="logout()">&#x2190; Sign out</div>
      </div>
    </div>
  </nav>

  <!-- ── Main ── -->
  <div class="main">
    <div class="mobile-header">
      <button class="hamburger" onclick="toggleSidebar()">&#9776;</button>
      <div class="logo" onclick="goHome()">
        <div class="logo-icon">R</div>
        RepoSpace
      </div>
      <div class="user-avatar" style="width:26px;height:26px;font-size:11px;cursor:pointer" onclick="logout()">A</div>
    </div>

    <!-- Screen: Repos -->
    <div class="screen active" id="screen-repos">
      <div class="page-header">
        <h1>Repositories</h1>
        <p>3 repositories connected</p>
      </div>
      <div class="content">
        <div class="repo-grid" id="repo-list"></div>
      </div>
    </div>

    <!-- Screen: Files -->
    <div class="screen" id="screen-files">
      <div class="branch-bar">
        <div class="branch-select" id="branch-select">
          <button class="branch-btn" onclick="toggleBranches(event)">
            <span class="branch-icon">&#9411;</span>
            <span id="current-branch">main</span>
            <span class="arrow">&#9662;</span>
          </button>
          <div class="branch-dropdown" id="branch-dropdown">
            <div class="branch-dropdown-header">Switch branch</div>
            <input class="branch-search" id="branch-search" placeholder="Filter branches..." oninput="filterBranches(this.value)">
            <div id="branch-options"></div>
          </div>
        </div>
      </div>
      <div class="view-tabs">
        <button class="view-tab active" id="tab-files" onclick="switchTab('files')">&#128196; Files</button>
        <button class="view-tab" id="tab-commits" onclick="switchTab('commits')">&#128340; Commits</button>
      </div>
      <div class="tab-divider"></div>
      <div id="files-view">
        <div class="file-header">
          <div class="breadcrumb" id="breadcrumb"></div>
          <span class="file-count" id="file-count"></span>
        </div>
        <div class="file-table" id="file-list"></div>
      </div>
      <div id="commits-view" style="display:none">
        <div class="commit-list" id="commit-list"></div>
      </div>
    </div>

    <!-- Screen: Document -->
    <div class="screen" id="screen-doc">
      <div class="doc-toolbar">
        <div class="doc-toolbar-left">
          <a class="back" id="doc-back">&#8592; Back</a>
          <span class="doc-name" id="doc-filename"></span>
        </div>
        <div class="doc-toolbar-right">
          <button class="btn" id="btn-raw">Source</button>
          <button class="btn btn-primary" id="btn-edit">Edit</button>
        </div>
      </div>
      <div class="doc-content" id="doc-viewer"></div>
      <div class="editor-wrap" id="doc-editor">
        <div class="editor-bar">
          <button onclick="ins('**','**')"><b>B</b></button>
          <button onclick="ins('_','_')"><i>I</i></button>
          <button onclick="ins('## ','')">H2</button>
          <button onclick="ins('[','](url)')">Link</button>
          <button onclick="ins('`','`')">Code</button>
          <button onclick="ins('- ','')">List</button>
        </div>
        <textarea class="editor-ta" id="editor-ta" spellcheck="true"></textarea>
      </div>
    </div>
  </div>
</div>

<!-- Save bar -->
<div class="save-bar" id="save-bar">
  <input type="text" id="commit-msg" placeholder="Commit message (optional)">
  <button class="btn" id="btn-cancel">Cancel</button>
  <button class="btn btn-primary" id="btn-save">Commit</button>
</div>

<!-- Changeset Panel -->
<div class="changeset-bar" id="changeset-bar">
  <div class="changeset-header" onclick="toggleChangesetItems()">
    <div class="changeset-title">
      &#128230; Pending changes <span class="changeset-count" id="changeset-count">0</span>
    </div>
    <div class="changeset-actions">
      <button class="btn" onclick="event.stopPropagation();clearChangeset()">Discard all</button>
    </div>
  </div>
  <div class="changeset-items" id="changeset-items"></div>
  <div class="changeset-commit">
    <input type="text" id="changeset-msg" placeholder="Move files to new locations">
    <button class="btn btn-primary" onclick="commitChangeset()">Commit changes</button>
  </div>
</div>

<!-- Drag ghost -->
<div class="drag-ghost" id="drag-ghost"></div>

<div class="toast" id="toast"></div>

<script>
// ═══════════════════════════════════════════════════════
// Data
// ═══════════════════════════════════════════════════════

const REPOS = [
  {
    id: 'ascaribe-platform', name: 'ascaribe-platform', owner: 'alimazid',
    desc: 'Company docs, websites, and AI agents project',
    lang: 'TypeScript', langColor: '#3178c6', updated: '2h ago', activity: '5 today',
    files: {
      'JOURNAL.md': { type:'md', size:'12 KB', updated:'2h ago', badge:'agent' },
      'company-docs/': { type:'folder', updated:'3d ago', children: {
        'DGII-RNC.pdf': { type:'other', size:'450 KB', updated:'2w ago' },
        'assembly-minutes.md': { type:'md', size:'3.2 KB', updated:'1w ago' },
      }},
      'projects/': { type:'folder', updated:'2h ago', children: {
        'whatsapp-ai-agents/': { type:'folder', updated:'2h ago', children: {
          'JOURNAL.md': { type:'md', size:'8.5 KB', updated:'2h ago', badge:'agent',
            content: `# WhatsApp AI Agents — Project Journal\n\n## Timeline\n\n### 2026-02-16 — Architecture Finalized\n- Completed 20-module action plan\n- Defined 87 actions across 5 phases\n- Architecture V2 document approved by Ali\n\n### 2026-02-15 — Market Research\n- Google Trends analysis: "ChatGPT" dominates DR market (score 74)\n- "AI agent" is invisible — need to position as "Tu propio ChatGPT para tu negocio"\n- Pricing adjusted: $99 / $199 / $399 USD/month\n\n### 2026-02-14 — Cost Analysis\n- Margins per plan: Básico 93%, Pro 87%, Business 81%\n- Break-even: 1 client\n- Initial investment: ~$55\n\n## Key Decisions\n1. **Workflow pattern over autonomous agent** — more predictable, cheaper\n2. **No frameworks** (LangChain, AutoGen) — function calling nativo\n3. **Google Sheets: LLM interprets raw** — each client has different format\n4. **One OpenClaw multi-tenant** — NOT one VPS per client\n5. **Management = conversation** — zero learning curve for owners\n\n## Pending Actions\n- [ ] Set up Stripe with Ali's Wise USD account\n- [ ] Build Phase 1: Core (FAQ + alerts)\n- [ ] First pilot client onboarding\n- [ ] Create demo video for landing page\n\n## Completed Actions\n- [x] Architecture V1 and V2 documents\n- [x] Cost analysis with margin breakdown\n- [x] 20 modules and 87 actions defined\n- [x] System flows documented\n- [x] Product page at ascaribe.com/agentes-ai/\n- [x] Proposal PDF generated` },
          'Pre-Project/': { type:'folder', updated:'1d ago', children: {
            'arquitectura-v2.md': { type:'md', size:'15 KB', updated:'1d ago' },
            'modulos-acciones.md': { type:'md', size:'9 KB', updated:'1d ago' },
          }}
        }}
      }},
      'websites/': { type:'folder', updated:'3d ago', children: {
        'ascaribe/': { type:'folder', updated:'3d ago', children: {
          'index.html': { type:'code', size:'28 KB', updated:'3d ago' },
          'agentes-ai.html': { type:'code', size:'15 KB', updated:'3d ago' },
        }},
      }},
      'README.md': { type:'md', size:'2.1 KB', updated:'1w ago',
        content: `# ASCaribe Platform\n\nA & S Caribe Services and Technology SRL — Company repository.\n\n## Structure\n\n- **company-docs/** — Legal documents (DGII, ONAPI, RNC)\n- **projects/** — Active projects and documentation\n- **websites/** — Static websites (ascaribe.com)\n\n## Active Projects\n\n### WhatsApp AI Agents\nAI-powered WhatsApp assistants for Dominican businesses.\nStatus: Pre-project documentation complete.\n\n### CobraPago\nWhatsApp payment reminder bot for SMBs. Status: MVP live.\n\n### BusCarro\nWhatsApp car search bot. Status: Live and working.` },
    }
  },
  {
    id: 'fastloop-trader', name: 'fastloop-trader', owner: 'alimazid',
    desc: 'Polymarket BTC fast market trader via Simmer API',
    lang: 'Python', langColor: '#3572A5', updated: '30m ago', activity: '2 today',
    files: {
      'fastloop_trader.py': { type:'code', size:'30 KB', updated:'30m ago', badge:'agent' },
      'config.json': { type:'json', size:'228 B', updated:'1h ago' },
      'PLAN.md': { type:'md', size:'3.4 KB', updated:'2h ago',
        content: `# FastLoop Trader — Plan de Implementación\n\n## Resumen\nPolymarket FastLoop Trader en Amsterdam para tradear BTC fast markets usando momentum de Binance.\n\n## Estado Actual\n\n### Completado\n- [x] Droplet Amsterdam creado (68.183.5.138)\n- [x] Bot instalado y configurado\n- [x] Venue Simmer ($SIM) para testing\n- [x] Cron cada 5 minutos activo\n- [x] Primer trade exitoso (+$9.71 SIM)\n- [x] Segundo trade exitoso (+$27.74 SIM)\n\n### Pendiente\n- [ ] Acumular 50+ trades para evaluar\n- [ ] Switch a Polymarket (USDC) si profitable` },
      'README.md': { type:'md', size:'800 B', updated:'2h ago' },
      '.gitignore': { type:'other', size:'60 B', updated:'2h ago' },
    }
  },
  {
    id: 'cobrapago-mvp', name: 'cobrapago-mvp', owner: 'alimazid',
    desc: 'WhatsApp payment reminder bot for Dominican SMBs',
    lang: 'TypeScript', langColor: '#3178c6', updated: '5d ago', activity: '',
    files: {
      'supabase/': { type:'folder', updated:'5d ago', children: {
        'functions/': { type:'folder', updated:'5d ago', children: {
          'whatsapp-webhook/': { type:'folder', updated:'5d ago', children: {
            'index.ts': { type:'code', size:'8 KB', updated:'5d ago' },
          }},
        }},
      }},
      'README.md': { type:'md', size:'1.5 KB', updated:'2w ago' },
    }
  }
];

// ═══════════════════════════════════════════════════════
// State
// ═══════════════════════════════════════════════════════
let currentRepo = null, currentPath = [], isEditing = false, originalContent = '', currentBranch = 'main', currentTab = 'files';

// ═══════════════════════════════════════════════════════
// Branches & Commits Data
// ═══════════════════════════════════════════════════════
const BRANCHES = {
  'ascaribe-platform': [
    { name: 'main', default: true, ahead: 0, behind: 0 },
    { name: 'develop', default: false, ahead: 3, behind: 0 },
    { name: 'feature/ai-agents-v2', default: false, ahead: 12, behind: 1 },
    { name: 'fix/webhook-timeout', default: false, ahead: 1, behind: 0 },
  ],
  'fastloop-trader': [
    { name: 'main', default: true, ahead: 0, behind: 0 },
    { name: 'develop', default: false, ahead: 5, behind: 0 },
    { name: 'experiment/weather-signals', default: false, ahead: 8, behind: 2 },
  ],
  'cobrapago-mvp': [
    { name: 'main', default: true, ahead: 0, behind: 0 },
    { name: 'develop', default: false, ahead: 2, behind: 0 },
  ]
};

const COMMITS = {
  'ascaribe-platform': {
    'main': [
      { sha: 'a3f8c21', msg: 'Update JOURNAL.md with architecture decisions', author: 'clawd', bot: true, time: '2 hours ago', date: 'Today', additions: 45, deletions: 3 },
      { sha: 'b72e910', msg: 'Add AI agents product page', author: 'clawd', bot: true, time: '3 hours ago', date: 'Today', additions: 320, deletions: 0 },
      { sha: 'e9d1f43', msg: 'Remove pricing section from agentes-ai.html', author: 'clawd', bot: true, time: '5 hours ago', date: 'Today', additions: 2, deletions: 48 },
      { sha: '1c4ab78', msg: 'Fix mobile nav overflow on landing page', author: 'clawd', bot: true, time: '8 hours ago', date: 'Today', additions: 12, deletions: 8 },
      { sha: '5fa2d66', msg: 'Deploy Macao Supply v3 with product pages', author: 'alimazid', bot: false, time: '1 day ago', date: 'Yesterday', additions: 1840, deletions: 620 },
      { sha: '8bc3e01', msg: 'Add client logos section to Macao Supply', author: 'clawd', bot: true, time: '1 day ago', date: 'Yesterday', additions: 95, deletions: 10 },
      { sha: 'd40f7a2', msg: 'Update company docs with DGII filing', author: 'alimazid', bot: false, time: '3 days ago', date: 'Feb 14', additions: 15, deletions: 2 },
      { sha: '7e1c890', msg: 'Initial website structure and design system', author: 'alimazid', bot: false, time: '1 week ago', date: 'Feb 10', additions: 2400, deletions: 0 },
    ],
    'develop': [
      { sha: 'f1a2b3c', msg: 'WIP: Multi-tenant webhook router', author: 'clawd', bot: true, time: '1 hour ago', date: 'Today', additions: 180, deletions: 20 },
      { sha: 'c4d5e6f', msg: 'Add tenant config schema', author: 'clawd', bot: true, time: '3 hours ago', date: 'Today', additions: 95, deletions: 0 },
      { sha: '9a8b7c6', msg: 'Scaffold Phase 1 module structure', author: 'clawd', bot: true, time: '5 hours ago', date: 'Today', additions: 240, deletions: 15 },
      { sha: 'a3f8c21', msg: 'Update JOURNAL.md with architecture decisions', author: 'clawd', bot: true, time: '2 hours ago', date: 'Today', additions: 45, deletions: 3 },
    ],
    'feature/ai-agents-v2': [
      { sha: 'aa11bb2', msg: 'Implement FAQ module with vector search', author: 'clawd', bot: true, time: '30 min ago', date: 'Today', additions: 310, deletions: 45 },
      { sha: 'cc33dd4', msg: 'Add WhatsApp message handler', author: 'clawd', bot: true, time: '2 hours ago', date: 'Today', additions: 175, deletions: 20 },
      { sha: 'ee55ff6', msg: 'Google Sheets integration for client data', author: 'clawd', bot: true, time: '4 hours ago', date: 'Today', additions: 220, deletions: 0 },
    ]
  },
  'fastloop-trader': {
    'main': [
      { sha: '3b2a1f0', msg: 'Add reasoning parameter to Simmer trades', author: 'clawd', bot: true, time: '30 min ago', date: 'Today', additions: 8, deletions: 2 },
      { sha: 'c8d7e6f', msg: 'Switch venue from polymarket to simmer for testing', author: 'clawd', bot: true, time: '1 hour ago', date: 'Today', additions: 15, deletions: 10 },
      { sha: '4a5b6c7', msg: 'Add Simmer API market search as primary discovery', author: 'clawd', bot: true, time: '2 hours ago', date: 'Today', additions: 85, deletions: 12 },
      { sha: '9f0e1d2', msg: 'Initial bot with Binance momentum strategy', author: 'alimazid', bot: false, time: '6 hours ago', date: 'Today', additions: 550, deletions: 0 },
      { sha: 'a1b2c3d', msg: 'Add config.json and PLAN.md', author: 'alimazid', bot: false, time: '8 hours ago', date: 'Today', additions: 120, deletions: 0 },
    ],
    'develop': [
      { sha: 'x1y2z3a', msg: 'Experiment: add volume-weighted momentum', author: 'clawd', bot: true, time: '20 min ago', date: 'Today', additions: 45, deletions: 12 },
      { sha: 'b4c5d6e', msg: 'Add backtesting mode', author: 'clawd', bot: true, time: '1 hour ago', date: 'Today', additions: 200, deletions: 5 },
      { sha: '3b2a1f0', msg: 'Add reasoning parameter to Simmer trades', author: 'clawd', bot: true, time: '30 min ago', date: 'Today', additions: 8, deletions: 2 },
    ]
  },
  'cobrapago-mvp': {
    'main': [
      { sha: 'f1e2d3c', msg: 'Fix reminder timezone handling', author: 'clawd', bot: true, time: '5 days ago', date: 'Feb 12', additions: 18, deletions: 6 },
      { sha: 'b4a5968', msg: 'Add process-reminders edge function', author: 'clawd', bot: true, time: '1 week ago', date: 'Feb 10', additions: 140, deletions: 0 },
      { sha: '7c8d9e0', msg: 'Webhook handler for WhatsApp messages', author: 'alimazid', bot: false, time: '2 weeks ago', date: 'Feb 3', additions: 280, deletions: 0 },
    ],
    'develop': [
      { sha: 'qq11rr2', msg: 'Add payment confirmation flow', author: 'clawd', bot: true, time: '5 days ago', date: 'Feb 12', additions: 95, deletions: 10 },
      { sha: 'f1e2d3c', msg: 'Fix reminder timezone handling', author: 'clawd', bot: true, time: '5 days ago', date: 'Feb 12', additions: 18, deletions: 6 },
    ]
  }
};

// ═══════════════════════════════════════════════════════
// Nav
// ═══════════════════════════════════════════════════════
function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.getElementById('save-bar').classList.remove('active');
}

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

function goHome() {
  currentRepo = null; currentPath = [];
  show('screen-repos');
  updateSidebar();
  closeSidebar();
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('overlay').classList.toggle('open');
}

function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('overlay').classList.remove('open');
}

// ═══════════════════════════════════════════════════════
// Sidebar
// ═══════════════════════════════════════════════════════
function updateSidebar() {
  const el = document.getElementById('sidebar-repos');
  el.innerHTML = REPOS.map(r => `
    <div class="sidebar-item ${currentRepo?.id === r.id ? 'active' : ''}" onclick="openRepo('${r.id}');closeSidebar()">
      <span class="dot" style="background:${r.langColor}"></span>
      ${r.name}
    </div>
  `).join('');
}

// ═══════════════════════════════════════════════════════
// Repos
// ═══════════════════════════════════════════════════════
// ═══════════════════════════════════════════════════════
// Branches
// ═══════════════════════════════════════════════════════
function toggleBranches(e) {
  e.stopPropagation();
  const dd = document.getElementById('branch-dropdown');
  dd.classList.toggle('open');
  if (dd.classList.contains('open')) {
    renderBranches();
    document.getElementById('branch-search').value = '';
    document.getElementById('branch-search').focus();
  }
}

function renderBranches(filter = '') {
  if (!currentRepo) return;
  const branches = BRANCHES[currentRepo.id] || [];
  const filtered = filter ? branches.filter(b => b.name.toLowerCase().includes(filter.toLowerCase())) : branches;
  document.getElementById('branch-options').innerHTML = filtered.map(b => {
    const isActive = b.name === currentBranch;
    const meta = b.default ? 'default' : (b.ahead ? `${b.ahead} ahead` : '');
    return `<div class="branch-option ${isActive ? 'active' : ''}" onclick="selectBranch('${b.name}')">
      <span>${b.name}</span>
      <span>${isActive ? '<span class="check-mark">&#10003;</span>' : `<span class="branch-meta">${meta}</span>`}</span>
    </div>`;
  }).join('');
}

function filterBranches(val) { renderBranches(val); }

function selectBranch(name) {
  currentBranch = name;
  document.getElementById('current-branch').textContent = name;
  document.getElementById('branch-dropdown').classList.remove('open');
  if (currentTab === 'commits') renderCommits();
  // In a real app, files would change per branch too
  toast(`Switched to ${name}`);
}

// Close dropdown on outside click
document.addEventListener('click', (e) => {
  if (!e.target.closest('#branch-select')) {
    document.getElementById('branch-dropdown')?.classList.remove('open');
  }
});

// ═══════════════════════════════════════════════════════
// Tabs (Files / Commits)
// ═══════════════════════════════════════════════════════
function switchTab(tab) {
  currentTab = tab;
  document.getElementById('tab-files').classList.toggle('active', tab === 'files');
  document.getElementById('tab-commits').classList.toggle('active', tab === 'commits');
  document.getElementById('files-view').style.display = tab === 'files' ? 'block' : 'none';
  document.getElementById('commits-view').style.display = tab === 'commits' ? 'block' : 'none';
  if (tab === 'commits') renderCommits();
}

function renderCommits() {
  if (!currentRepo) return;
  const allCommits = COMMITS[currentRepo.id]?.[currentBranch] || COMMITS[currentRepo.id]?.['main'] || [];

  // Group by date
  const groups = {};
  allCommits.forEach(c => {
    if (!groups[c.date]) groups[c.date] = [];
    groups[c.date].push(c);
  });

  let html = '';
  for (const [date, commits] of Object.entries(groups)) {
    html += `<div class="commit-group-label">${date}</div>`;
    commits.forEach(c => {
      html += `<div class="commit-row" onclick="toast('Commit ${c.sha} details')">
        <div class="commit-avatar ${c.bot ? 'bot' : ''}">${c.bot ? '&#9881;' : c.author[0].toUpperCase()}</div>
        <div class="commit-info">
          <div class="commit-msg">${c.msg}</div>
          <div class="commit-detail">
            <span class="author">${c.author}</span>
            <span>committed ${c.time}</span>
          </div>
        </div>
        <div class="commit-stats">
          <span class="additions">+${c.additions}</span>
          <span class="deletions">-${c.deletions}</span>
        </div>
        <span class="commit-sha" onclick="event.stopPropagation();navigator.clipboard?.writeText('${c.sha}');toast('Copied ${c.sha}')">${c.sha}</span>
      </div>`;
    });
  }

  document.getElementById('commit-list').innerHTML = html;
}

function renderRepos() {
  document.getElementById('repo-list').innerHTML = REPOS.map(r => `
    <div class="repo-row" onclick="openRepo('${r.id}')">
      <div class="repo-icon">&#128193;</div>
      <div class="info">
        <div class="name">${r.owner}/${r.name}</div>
        <div class="desc">${r.desc}</div>
      </div>
      <div class="meta">
        ${r.activity ? `<span class="badge badge-blue">${r.activity}</span>` : ''}
        <span class="lang"><span class="dot" style="background:${r.langColor}"></span>${r.lang}</span>
        <span class="updated">${r.updated}</span>
      </div>
    </div>
  `).join('');
}

// ═══════════════════════════════════════════════════════
// Files
// ═══════════════════════════════════════════════════════
function openRepo(id) {
  currentRepo = REPOS.find(r => r.id === id);
  currentPath = [];
  currentBranch = 'main';
  currentTab = 'files';
  document.getElementById('current-branch').textContent = 'main';
  document.getElementById('tab-files').classList.add('active');
  document.getElementById('tab-commits').classList.remove('active');
  document.getElementById('files-view').style.display = 'block';
  document.getElementById('commits-view').style.display = 'none';
  renderFiles();
  show('screen-files');
  updateSidebar();
}

function getFiles() {
  let n = currentRepo.files;
  for (const s of currentPath) { const f = n[s+'/']; if (f?.children) n = f.children; }
  return n;
}

function renderFiles() {
  // Breadcrumb
  let bc = `<a onclick="currentPath=[];renderFiles()">${currentRepo.name}</a>`;
  currentPath.forEach((s, i) => {
    bc += `<span class="sep">/</span>`;
    bc += i < currentPath.length-1
      ? `<a onclick="currentPath=currentPath.slice(0,${i+1});renderFiles()">${s}</a>`
      : `<span class="current">${s}</span>`;
  });
  document.getElementById('breadcrumb').innerHTML = bc;

  const files = getFiles();
  const entries = Object.entries(files).map(([name, info]) => {
    const isFolder = name.endsWith('/');
    return { name: name.replace(/\/$/,''), raw: name, isFolder, ...info };
  }).sort((a,b) => a.isFolder === b.isFolder ? a.name.localeCompare(b.name) : a.isFolder ? -1 : 1);

  const folders = entries.filter(e => e.isFolder).length;
  const filesCount = entries.length - folders;
  document.getElementById('file-count').textContent = `${folders} folders, ${filesCount} files`;

  document.getElementById('file-list').innerHTML = entries.map(e => {
    let icon = '&#128196;';
    if (e.isFolder) icon = '&#128194;';
    else if (e.name.endsWith('.md')) icon = '&#128221;';
    else if (/\.(ts|js|py|html)$/.test(e.name)) icon = '&#128187;';
    else if (e.name.endsWith('.json')) icon = '{ }';

    const fullPath = [...currentPath, e.name].join('/');
    const click = e.isFolder
      ? `currentPath.push('${e.name}');renderFiles()`
      : `openFile('${e.raw}')`;

    return `
      <div class="file-row" draggable="true" data-name="${e.name}" data-path="${fullPath}" data-folder="${e.isFolder}" onclick="${click}">
        <span class="f-icon">${icon}</span>
        <span class="f-name ${e.isFolder ? 'folder' : ''}">${e.name}${e.isFolder ? '/' : ''}</span>
        ${e.badge ? '<span class="f-badge">agent</span>' : ''}
        <span class="f-meta">${e.size || ''}</span>
        <span class="f-time">${e.updated || ''}</span>
      </div>`;
  }).join('');

  // Attach drag events after rendering
  attachDragEvents();

  // Also make breadcrumb segments droppable
  attachBreadcrumbDropEvents();
}

// ═══════════════════════════════════════════════════════
// Document
// ═══════════════════════════════════════════════════════
function openFile(filename) {
  const files = getFiles();
  const file = files[filename];
  if (!file || (!filename.endsWith('.md') && !file.content)) {
    toast('Preview not available'); return;
  }
  const content = file.content || `# ${filename}\n\nNo content.`;
  originalContent = content;

  document.getElementById('doc-filename').textContent = filename;
  document.getElementById('doc-viewer').innerHTML =
    `<div class="doc-meta"><span>Last edited ${file.updated}</span><span>${file.size}</span></div>` +
    renderMd(content);
  document.getElementById('doc-viewer').style.display = 'block';
  document.getElementById('editor-ta').value = content;
  document.getElementById('doc-editor').classList.remove('active');
  document.getElementById('save-bar').classList.remove('active');
  document.getElementById('btn-edit').textContent = 'Edit';
  isEditing = false;
  show('screen-doc');
}

function renderMd(md) {
  return md
    .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/^> (.+)$/gm, '<blockquote><p>$1</p></blockquote>')
    .replace(/^- \[x\] (.+)$/gm, '<ul class="checklist"><li><span class="check done">&#9745;</span> $1</li></ul>')
    .replace(/^- \[ \] (.+)$/gm, '<ul class="checklist"><li><span class="check">&#9744;</span> $1</li></ul>')
    .replace(/^- (.+)$/gm, '<li>$1</li>')
    .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
    .replace(/^(?!<[hluopb])((?!<).+)$/gm, '<p>$1</p>')
    .replace(/<\/ul>\s*<ul class="checklist">/g, '')
    .replace(/<\/li>\n<li>/g, '</li><li>');
}

// Edit
document.getElementById('btn-edit').addEventListener('click', () => {
  isEditing = !isEditing;
  if (isEditing) {
    document.getElementById('doc-viewer').style.display = 'none';
    document.getElementById('doc-editor').classList.add('active');
    document.getElementById('save-bar').classList.add('active');
    document.getElementById('btn-edit').textContent = 'Preview';
    document.getElementById('editor-ta').focus();
  } else {
    document.getElementById('doc-viewer').innerHTML = renderMd(document.getElementById('editor-ta').value);
    document.getElementById('doc-viewer').style.display = 'block';
    document.getElementById('doc-editor').classList.remove('active');
    document.getElementById('save-bar').classList.remove('active');
    document.getElementById('btn-edit').textContent = 'Edit';
  }
});

document.getElementById('btn-raw').addEventListener('click', () => {
  if (isEditing) return;
  const v = document.getElementById('doc-viewer');
  if (v.dataset.raw === '1') {
    v.innerHTML = renderMd(originalContent); v.dataset.raw = '0';
  } else {
    v.innerHTML = `<pre><code>${originalContent.replace(/</g,'&lt;')}</code></pre>`; v.dataset.raw = '1';
  }
});

document.getElementById('btn-cancel').addEventListener('click', () => {
  document.getElementById('editor-ta').value = originalContent;
  isEditing = false;
  document.getElementById('doc-viewer').innerHTML = renderMd(originalContent);
  document.getElementById('doc-viewer').style.display = 'block';
  document.getElementById('doc-editor').classList.remove('active');
  document.getElementById('save-bar').classList.remove('active');
  document.getElementById('btn-edit').textContent = 'Edit';
});

document.getElementById('btn-save').addEventListener('click', () => {
  const content = document.getElementById('editor-ta').value;
  const msg = document.getElementById('commit-msg').value || 'Update document';
  originalContent = content;
  isEditing = false;
  document.getElementById('doc-viewer').innerHTML =
    `<div class="doc-meta"><span>Last edited just now</span></div>` + renderMd(content);
  document.getElementById('doc-viewer').style.display = 'block';
  document.getElementById('doc-editor').classList.remove('active');
  document.getElementById('save-bar').classList.remove('active');
  document.getElementById('btn-edit').textContent = 'Edit';
  toast(`Committed: "${msg}"`);
});

document.getElementById('doc-back').addEventListener('click', () => show('screen-files'));

function ins(b, a) {
  const ta = document.getElementById('editor-ta');
  const s = ta.selectionStart, e = ta.selectionEnd, sel = ta.value.substring(s, e);
  ta.value = ta.value.substring(0,s) + b + sel + a + ta.value.substring(e);
  ta.focus(); ta.selectionStart = s+b.length; ta.selectionEnd = s+b.length+sel.length;
}

// ═══════════════════════════════════════════════════════
// Drag & Drop + Changeset
// ═══════════════════════════════════════════════════════
let changeset = []; // Array of { from, to, name, isFolder }
let dragItem = null;
let changesetExpanded = true;
let touchDrag = null; // { el, startX, startY, ghost, active }

function attachDragEvents() {
  const rows = document.querySelectorAll('#file-list .file-row');
  rows.forEach(row => {
    // Desktop drag
    row.addEventListener('dragstart', onDragStart);
    row.addEventListener('dragend', onDragEnd);
    row.addEventListener('dragover', onDragOver);
    row.addEventListener('dragleave', onDragLeave);
    row.addEventListener('drop', onDrop);
    // Mobile touch
    row.addEventListener('touchstart', onTouchStart, { passive: false });
  });
}

// ── Mobile Touch Drag ──
const TOUCH_HOLD_MS = 300;
const TOUCH_MOVE_THRESHOLD = 10;
let touchHoldTimer = null;

function onTouchStart(e) {
  const row = e.currentTarget;
  const touch = e.touches[0];
  const startX = touch.clientX;
  const startY = touch.clientY;

  // Start hold timer
  touchDrag = { el: row, startX, startY, active: false };

  touchHoldTimer = setTimeout(() => {
    if (!touchDrag) return;
    touchDrag.active = true;
    row.classList.add('dragging');
    // Show ghost
    const ghost = document.getElementById('drag-ghost');
    const name = row.dataset.name;
    const isFolder = row.dataset.folder === 'true';
    ghost.textContent = (isFolder ? '📁 ' : '📄 ') + name;
    ghost.style.display = 'block';
    ghost.style.left = startX + 'px';
    ghost.style.top = (startY - 40) + 'px';
    // Haptic feedback if available
    if (navigator.vibrate) navigator.vibrate(30);
  }, TOUCH_HOLD_MS);

  // Attach move/end to document (once)
  document.addEventListener('touchmove', onTouchMove, { passive: false });
  document.addEventListener('touchend', onTouchEnd);
  document.addEventListener('touchcancel', onTouchCancel);
}

function onTouchMove(e) {
  if (!touchDrag) return;
  const touch = e.touches[0];
  const dx = touch.clientX - touchDrag.startX;
  const dy = touch.clientY - touchDrag.startY;

  // Cancel hold if moved before threshold
  if (!touchDrag.active && (Math.abs(dx) > TOUCH_MOVE_THRESHOLD || Math.abs(dy) > TOUCH_MOVE_THRESHOLD)) {
    clearTimeout(touchHoldTimer);
    if (!touchDrag.active) {
      cleanupTouch();
      return;
    }
  }

  if (!touchDrag.active) return;
  e.preventDefault(); // Prevent scroll while dragging

  // Move ghost
  const ghost = document.getElementById('drag-ghost');
  ghost.style.left = touch.clientX + 'px';
  ghost.style.top = (touch.clientY - 40) + 'px';

  // Highlight drop target
  const rows = document.querySelectorAll('#file-list .file-row');
  rows.forEach(r => r.classList.remove('drag-over-folder', 'drag-over'));

  const target = document.elementFromPoint(touch.clientX, touch.clientY);
  const targetRow = target?.closest('.file-row');
  if (targetRow && targetRow !== touchDrag.el && targetRow.dataset.folder === 'true') {
    targetRow.classList.add('drag-over-folder');
  }

  // Highlight breadcrumbs
  document.querySelectorAll('#breadcrumb a').forEach(a => a.classList.remove('drag-over-bc'));
  const bcTarget = target?.closest('#breadcrumb a');
  if (bcTarget) bcTarget.classList.add('drag-over-bc');
}

function onTouchEnd(e) {
  clearTimeout(touchHoldTimer);
  if (!touchDrag || !touchDrag.active) {
    cleanupTouch();
    return;
  }

  const touch = e.changedTouches[0];
  const target = document.elementFromPoint(touch.clientX, touch.clientY);

  // Check if dropped on a folder row
  const targetRow = target?.closest('.file-row');
  if (targetRow && targetRow !== touchDrag.el && targetRow.dataset.folder === 'true') {
    const fromPath = touchDrag.el.dataset.path;
    const fromName = touchDrag.el.dataset.name;
    const isFolder = touchDrag.el.dataset.folder === 'true';
    const toPath = targetRow.dataset.path + '/' + fromName;
    if (fromPath !== toPath) {
      addToChangeset(fromPath, toPath, fromName, isFolder);
    }
  }

  // Check if dropped on breadcrumb
  const bcTarget = target?.closest('#breadcrumb a');
  if (bcTarget) {
    const links = [...document.querySelectorAll('#breadcrumb a')];
    const idx = links.indexOf(bcTarget);
    const targetPathArr = currentPath.slice(0, idx);
    const targetPath = targetPathArr.join('/');
    const fromPath = touchDrag.el.dataset.path;
    const fromName = touchDrag.el.dataset.name;
    const isFolder = touchDrag.el.dataset.folder === 'true';
    const toPath = targetPath ? targetPath + '/' + fromName : fromName;
    if (fromPath !== toPath) {
      addToChangeset(fromPath, toPath, fromName, isFolder);
    }
  }

  cleanupTouch();
}

function onTouchCancel() {
  clearTimeout(touchHoldTimer);
  cleanupTouch();
}

function cleanupTouch() {
  if (touchDrag?.el) touchDrag.el.classList.remove('dragging');
  document.querySelectorAll('.drag-over-folder, .drag-over, .drag-over-bc').forEach(el => {
    el.classList.remove('drag-over-folder', 'drag-over', 'drag-over-bc');
  });
  document.getElementById('drag-ghost').style.display = 'none';
  touchDrag = null;
  document.removeEventListener('touchmove', onTouchMove);
  document.removeEventListener('touchend', onTouchEnd);
  document.removeEventListener('touchcancel', onTouchCancel);
}

function attachBreadcrumbDropEvents() {
  const links = document.querySelectorAll('#breadcrumb a');
  links.forEach((link, i) => {
    link.addEventListener('dragover', (e) => {
      e.preventDefault();
      link.classList.add('drag-over-bc');
    });
    link.addEventListener('dragleave', () => {
      link.classList.remove('drag-over-bc');
    });
    link.addEventListener('drop', (e) => {
      e.preventDefault();
      link.classList.remove('drag-over-bc');
      if (!dragItem) return;
      // Determine target path from breadcrumb index
      // index 0 = root, 1 = currentPath[0], etc.
      const targetPath = currentPath.slice(0, i).join('/');
      const fromPath = dragItem.dataset.path;
      const name = dragItem.dataset.name;
      if (targetPath === currentPath.slice(0, currentPath.length).join('/').split('/').slice(0, -1).join('/') && fromPath.startsWith(targetPath)) {
        // Already in that folder, or same level
      }
      addToChangeset(fromPath, targetPath ? targetPath + '/' + name : name, name, dragItem.dataset.folder === 'true');
    });
  });
}

function onDragStart(e) {
  dragItem = e.currentTarget;
  e.currentTarget.classList.add('dragging');
  const name = e.currentTarget.dataset.name;
  const isFolder = e.currentTarget.dataset.folder === 'true';
  e.dataTransfer.effectAllowed = 'move';
  // Custom ghost
  const ghost = document.getElementById('drag-ghost');
  ghost.textContent = (isFolder ? '📁 ' : '📄 ') + name;
  ghost.style.display = 'block';
  ghost.style.left = '-999px';
  e.dataTransfer.setDragImage(ghost, 0, 0);
}

function onDragEnd(e) {
  e.currentTarget.classList.remove('dragging');
  document.getElementById('drag-ghost').style.display = 'none';
  document.querySelectorAll('.drag-over, .drag-over-folder, .drag-over-bc').forEach(el => {
    el.classList.remove('drag-over', 'drag-over-folder', 'drag-over-bc');
  });
  dragItem = null;
}

function onDragOver(e) {
  e.preventDefault();
  const row = e.currentTarget;
  if (row === dragItem) return;
  e.dataTransfer.dropEffect = 'move';
  const isFolder = row.dataset.folder === 'true';
  if (isFolder) {
    row.classList.add('drag-over-folder');
    row.classList.remove('drag-over');
  } else {
    row.classList.add('drag-over');
    row.classList.remove('drag-over-folder');
  }
}

function onDragLeave(e) {
  e.currentTarget.classList.remove('drag-over', 'drag-over-folder');
}

function onDrop(e) {
  e.preventDefault();
  e.stopPropagation();
  const target = e.currentTarget;
  target.classList.remove('drag-over', 'drag-over-folder');
  if (!dragItem || target === dragItem) return;

  const fromPath = dragItem.dataset.path;
  const fromName = dragItem.dataset.name;
  const isFolder = dragItem.dataset.folder === 'true';
  const targetIsFolder = target.dataset.folder === 'true';

  let toPath;
  if (targetIsFolder) {
    // Drop into folder
    toPath = target.dataset.path + '/' + fromName;
  } else {
    // Drop next to file = same directory (reorder, but we treat as no-op for path)
    toast('Drop onto a folder to move');
    return;
  }

  if (fromPath === toPath) return;

  addToChangeset(fromPath, toPath, fromName, isFolder);
}

function addToChangeset(from, to, name, isFolder) {
  // Check for duplicates
  const exists = changeset.find(c => c.from === from && c.to === to);
  if (exists) return;
  // Check if already moved this file (update instead)
  const idx = changeset.findIndex(c => c.from === from);
  if (idx >= 0) {
    changeset[idx].to = to;
  } else {
    changeset.push({ from, to, name, isFolder });
  }
  renderChangeset();
  toast(`${isFolder ? '📁' : '📄'} ${name} → ${to.split('/').slice(0,-1).join('/') || 'root'}`);
}

function renderChangeset() {
  const bar = document.getElementById('changeset-bar');
  const count = document.getElementById('changeset-count');
  const items = document.getElementById('changeset-items');

  if (changeset.length === 0) {
    bar.classList.remove('active');
    return;
  }

  bar.classList.add('active');
  count.textContent = changeset.length;

  // Auto-generate commit message
  const msgInput = document.getElementById('changeset-msg');
  if (changeset.length === 1) {
    msgInput.value = `Move ${changeset[0].name} to ${changeset[0].to.split('/').slice(0,-1).join('/') || 'root'}`;
  } else {
    msgInput.value = `Move ${changeset.length} files`;
  }

  items.style.display = changesetExpanded ? 'block' : 'none';

  items.innerHTML = changeset.map((c, i) => `
    <div class="changeset-item">
      <span class="cs-icon">${c.isFolder ? '&#128194;' : '&#128196;'}</span>
      <span class="cs-action move">move</span>
      <div class="cs-paths">
        <span class="cs-from">${c.from}</span>
        <span class="cs-arrow">→</span>
        <span class="cs-to">${c.to}</span>
      </div>
      <button class="cs-undo" onclick="undoChange(${i})" title="Undo">&#10005;</button>
    </div>
  `).join('');
}

function undoChange(index) {
  changeset.splice(index, 1);
  renderChangeset();
  if (changeset.length === 0) toast('All changes discarded');
}

function clearChangeset() {
  changeset = [];
  renderChangeset();
  toast('All changes discarded');
}

function toggleChangesetItems() {
  changesetExpanded = !changesetExpanded;
  const items = document.getElementById('changeset-items');
  items.style.display = changesetExpanded ? 'block' : 'none';
}

function commitChangeset() {
  const msg = document.getElementById('changeset-msg').value || `Move ${changeset.length} files`;
  const count = changeset.length;
  changeset = [];
  renderChangeset();
  toast(`Committed: "${msg}" (${count} file${count > 1 ? 's' : ''} moved)`);
}

// ═══════════════════════════════════════════════════════
// Auth Flow
// ═══════════════════════════════════════════════════════
let isAuthenticated = false;

function showGitHubAuth() {
  document.getElementById('auth-login').classList.remove('active');
  document.getElementById('auth-github').classList.add('active');
}

function cancelGitHubAuth() {
  document.getElementById('auth-github').classList.remove('active');
  document.getElementById('auth-login').classList.add('active');
}

function authorizeGitHub() {
  document.getElementById('auth-github').classList.remove('active');
  document.getElementById('auth-loading').classList.add('active');

  const steps = ['ls-auth', 'ls-repos', 'ls-ready'];
  let i = 0;

  function nextStep() {
    if (i > 0) {
      const prev = document.getElementById(steps[i-1]);
      prev.classList.remove('active');
      prev.classList.add('done');
      prev.querySelector('.ls-icon').textContent = '✓';
    }
    if (i < steps.length) {
      const curr = document.getElementById(steps[i]);
      curr.classList.add('active');
      curr.querySelector('.ls-icon').textContent = '◌';
      i++;
      setTimeout(nextStep, 800 + Math.random() * 400);
    } else {
      // Done — show main app
      setTimeout(() => {
        document.getElementById('auth-loading').classList.remove('active');
        document.getElementById('main-layout').style.display = 'flex';
        isAuthenticated = true;
        toast('Welcome, alimazid!');
      }, 500);
    }
  }

  // Start loading sequence
  document.querySelector('.loading-text').textContent = 'Connecting to GitHub...';
  setTimeout(nextStep, 600);
}

function toggleUserMenu(e) {
  e.stopPropagation();
  document.getElementById('user-menu').classList.toggle('open');
}

document.addEventListener('click', () => {
  document.getElementById('user-menu')?.classList.remove('open');
});

function logout() {
  document.getElementById('main-layout').style.display = 'none';
  document.getElementById('auth-login').classList.add('active');
  currentRepo = null;
  currentPath = [];
  changeset = [];
  renderChangeset();
  show('screen-repos');
  closeSidebar();
  isAuthenticated = false;
  logoClicks = 0;
  // Reset loading steps
  ['ls-auth','ls-repos','ls-ready'].forEach(id => {
    const el = document.getElementById(id);
    el.classList.remove('done','active');
    el.querySelector('.ls-icon').textContent = '○';
  });
  toast('Signed out');
}

// Skip auth (for development - click logo 3 times)
let logoClicks = 0;
function skipAuth() {
  logoClicks++;
  if (logoClicks >= 3) {
    document.getElementById('auth-login').classList.remove('active');
    document.getElementById('main-layout').style.display = 'flex';
    isAuthenticated = true;
    toast('Dev mode — skipped auth');
  }
}

// ═══════════════════════════════════════════════════════
// Init
// ═══════════════════════════════════════════════════════
renderRepos();
updateSidebar();
</script>
</body>
</html>
<!-- v2 -->
